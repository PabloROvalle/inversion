*******************************************************************************
*******************************************************************************
C------------------------------------------------------------------------------
C
C                           SUBROUTINE NEWGRAV
C
C      Sets the gravitational acceleration based on selected planet and 
C      latitude. Gravity is calculated normal to the surface, and corrected 
C      for rotational effects. The input latitude is assumed planetographic.
C
C      The radial vector component of the gravitational acceleration is
C      given by Lindal et al., 1986, Astr. J., 90 (6), 1136-1146, as the
C      expression
C                      ___inf
C          G M  (    \                    (R)**2n                  )
C      g = ---- ( 1 - \     (2n + 1) J_2n (-)     P_2n (sin(latc)) )
C          r**2 (     /__n=1              (r)                      )
C
C                       2
C                    -  - omega**2 r (1 - P_2(sin(latc)))
C                       3
C
C      where r = radial distance, G = gravitational constant, M = planet
C      mass, J_2n is the 2nth zonal harmonic coefficient, P_2n is the
C      Legendre polynomial of order 2n, and latc is the planetocentric
C      latitude. Note that the notation is using spherical coords based
C      on the planet centre. The last part of the expression is simply
C      the centrifugal component and is more simply written as
C
C                           omega**2 r cos(latc)**2.
C
C      The latitudinal vector component is given by the expression
C
C                 ___inf
C          G M  ( \            (R)**2n  d P_2n (sin(latc)) )
C      g = ---- (  \      J_2n (-)      ------------------ )
C          r**2 (  /__n=1      (r)            d latc       )
C
C                      1            d P_2 (sin(latc))
C                    + - omega**2 r -----------------
C                      3                 d latc
C
C      where the notation is as above. The derivatives of the Legendre
C      polynomials can be found through the recurrence relation
C
C                        d P_2n (z)
C             (z**2 - 1) ---------- = 2 n (z P_2n (z) - P_(2n-1) (z)).
C                           d z
C
C      Using this relation, it can be seen that the last expression of
C      the latitudinal component represents centrifugal acceleration and
C      is more clearly written as
C
C                           omega**2 r cos(latc) sin(latc).
C
C      These two gravitational vector components are normal to each other
C      and must be summed to give the overall gravity acting normal to the
C      planetary surface.
C
C      Original version    A.Weir
C      Adapted for general use 29/4/96  Pat Irwin
C-------------------------------------------------------------------------------

subroutine newgrav (lat_in, h, g) 

  implicit none
  include 'declaration.f'

  real, intent(in) :: lat_in, h ! Latitude (degrees), Height above reference surface (km)

!       radius		real		Planetary radius (km) at latitude lat
  real, intent(ou)::  g	!gravity acc. (m/s2)

  integer :: I
  real :: lat, pi, latc, thetagc, slatc, r, legpol, clatc, gtheta, Rr, radius
  real*4 xgm,xradius,xellip,xomega,grav
  real, dimension(3) :: xcoeff
  real, dimension(6) :: pol
  real, parameter :: Grav = 6.672E-11
  real, parameter :: pi= 3.141592654

  xgm = MassSat*Grav*1e24*1e6
  xcoeff(1) = J2sat/1e3
  xcoeff(2) = J3sat/1e6
  xcoeff(3) = J4sat/1e8
  xradius = Rsat*1e2
  xellip = 1./(1.-ellip)
  xomega = 2*pi/(omega*24.0*3600.0)

  lat = 2 * pi * lat_in/360.
  latc = thetagc(lat, xellip)
  slatc = sin(latc)
  clatc = cos(latc)

!      Rr is the ratio of radius at equator to radius at current latitude
  Rr = sqrt(clatc**2 + (xellip**2 * slatc**2))
  r = (xradius+h*1e5)/Rr
  radius = (xradius/Rr)*1e-5

  do I = 1, 6
     pol(I) = legpol(I,slatc)
  enddo

!-------------------------------------------------------------------------------
!
!      Evaluate radial contribution from summation for first three terms,
!      then subtract centrifugal effect.
!
!-------------------------------------------------------------------------------

  g = 1.
  do I = 1, 3
     g = g - ((2*I+1) * Rr**(2 * I) * xcoeff(I) * pol(2*I))
     !              print*,g*0.01*xgm/r**2
  enddo

  g = (g * xgm/r**2) - (r * xomega**2 * clatc**2)
!       print*,'gradial = ',g*0.01
!-------------------------------------------------------------------------------
!
!      Evaluate latitudinal contribution for first three terms, then add
!      centrifugal effects.
!
!-------------------------------------------------------------------------------

  gtheta = 0.
  do I = 1, 3
     gtheta = gtheta - (4 * I**2 * Rr**(2 * I) * xcoeff(I) * (pol(2*I-1) - slatc * pol(2*I))/clatc)
     !       print*,gtheta*0.01*xgm/r**2
  enddo

  gtheta = (gtheta * xgm/r**2) + (r * xomega**2 *  clatc * slatc)

!       print*,'gtheta = ',gtheta*0.01
!-------------------------------------------------------------------------------
!
!      Combine the two components and write the result.
!
!-------------------------------------------------------------------------------

  g = sqrt(g**2 + gtheta**2)*0.01
  print*, lat_in, h, g 

end subroutine newgrav

********************************************************************************
********************************************************************************

C-------------------------------------------------------------------------------
C
C                           FUNCTION THETAGC
C
C      Converts planetographic latitude to planetocentric. Angles must be
C      supplied in radians.
C
C-------------------------------------------------------------------------------

       function thetagc (lat, e)

       implicit none
       real*4        e, lat, thetagc

       thetagc = atan(tan(lat)/e**2)

       end

********************************************************************************
********************************************************************************
C-------------------------------------------------------------------------------
C
C                           FUNCTION LEGPOL
C
C      Calculates zero order Legendre polynomials based on the recurrence
C      relation 
C               (n) P   (z) = (2n-1) z P    (z) - (n-1) P     (z).
C                    (n)                (n-1)            (n-2)
C
C-------------------------------------------------------------------------------

       function legpol (n, z)
       
       implicit none
       integer       I, n
       real*4        legpol, z, pol(3)

       pol(1) = 1.
       pol(2) = z

       if ((n.eq.0).or.(n.eq.1)) then
              legpol = pol(n+1)
       else
              I = 1
10            I = I + 1

              if (I.gt.50) then
                     write (*,*) '* * * * * * * * * * * * *'
                     write (*,*) '*                       *'
                     write (*,*) '*   Looping in LEGPOL   *'
                     write (*,*) '*   Program terminated  *'
                     write (*,*) '*                       *'
                     write (*,*) '* * * * * * * * * * * * *'
              endif

              pol(3) = (((2 * I - 1) * pol(2) * z) 
     1               - ((I - 1) * pol(1)))/float(I)
              if (I.eq.n) then
                     legpol = pol(3)
                     return
              else
                     pol(1) = pol(2)
                     pol(2) = pol(3)
                     goto 10
              endif
       endif


       end

********************************************************************************
********************************************************************************
